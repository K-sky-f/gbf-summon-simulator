<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨å›è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .reset-btn { padding: 8px 12px; background-color: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; }

        /* ã‚¯ã‚¨ã‚¹ãƒˆã¨ç´ æã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .quest-section { border: 2px solid #3f51b5; padding: 15px; margin-bottom: 20px; border-radius: 6px; position: relative; }
        .quest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .quest-header h2 { margin: 0; }
        .delete-quest-btn { background: none; border: none; color: #f44336; font-size: 20px; cursor: pointer; padding: 0 5px; }

        .material-row { display: flex; gap: 5px; margin-bottom: 10px; align-items: center; }
        .material-row input { padding: 6px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 0; min-width: 0;}
        .material-name-input { flex-basis: 120px; }
        .material-target-input, .material-current-input, .material-avg-input { flex-basis: 70px; }
        .material-time-input { flex-basis: 60px; }
        .delete-material-btn { background: none; border: none; color: #f44336; font-size: 18px; cursor: pointer; padding: 0 5px; flex-shrink:0; }
        
        /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .add-material-btn, #add-quest-btn { padding: 6px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; }
        #add-quest-btn { display: block; width: 100%; margin-top: 15px; background-color: #3f51b5; }

        /* çµæœè¡¨ç¤º */
        .result { margin-top: 30px; padding: 15px; background-color: #e8eaf6; border-radius: 4px; }
        .result p { font-size: 1.1em; font-weight: bold; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <button id="reset-btn" class="reset-btn">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="quests-container">
        </div>

    <button id="add-quest-btn">ã‚¯ã‚¨ã‚¹ãƒˆï¼‹</button>

    <hr>

    <div class="result">
        <p>ç´ æã‚’é›†ã‚ã‚‹ãŸã‚ã«ã¯ã€ä»¥ä¸‹ã®å‘¨å›ãŒå¿…è¦ã§ã™ã€‚</p>
        <div id="quest-runs-result"></div>
        <p>åˆè¨ˆ<span id="total-time-hours">0</span>æ™‚é–“<span id="total-time-minutes">0</span>åˆ†å¿…è¦ã§ã™ã€‚</p>
        <div id="efficiency-tip"></div>
    </div>
</div>

<script>
    const questsContainer = document.getElementById('quests-container');
    const addQuestBtn = document.getElementById('add-quest-btn');
    const resetBtn = document.getElementById('reset-btn');
    const questRunsResult = document.getElementById('quest-runs-result');
    const totalTimeHoursSpan = document.getElementById('total-time-hours');
    const totalTimeMinutesSpan = document.getElementById('total-time-minutes');
    const efficiencyTipDiv = document.getElementById('efficiency-tip');
    let questCount = 0;

    // ã‚¯ã‚¨ã‚¹ãƒˆã®HTMLã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function createQuestHtml(id, name, isDeletable) {
        return `
            <div class="quest-section" data-quest-id="${id}">
                <div class="quest-header">
                    <h2>${name}</h2>
                    ${isDeletable ? `<button class="delete-quest-btn" data-quest-id="${id}">Ã—</button>` : ''}
                </div>
                <div class="materials-container">
                    <div class="material-row">
                        <input type="text" placeholder="ç´ æå" class="material-name-input" data-name="name">
                        <input type="number" placeholder="ç›®æ¨™å€‹æ•°" class="material-target-input" data-name="target" value="10">
                        <input type="number" placeholder="ç¾åœ¨ã®å€‹æ•°" class="material-current-input" data-name="current" value="0">
                        <input type="number" placeholder="ä¸€å‘¨å¹³å‡" class="material-avg-input" data-name="avg" value="1">
                        <input type="number" placeholder="æ™‚é–“(åˆ†)" class="material-time-input" data-name="time" value="10">
                        <button class="delete-material-btn" style="visibility:hidden;">Ã—</button>
                    </div>
                </div>
                <button class="add-material-btn" data-quest-id="${id}">ï¼‹</button>
            </div>
        `;
    }

    // ã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addQuest(isInitial = false) {
        if (questCount >= 10) {
            alert('ã‚¯ã‚¨ã‚¹ãƒˆã¯æœ€å¤§10å€‹ã¾ã§ã§ã™ã€‚');
            return;
        }
        questCount++;
        const questId = `quest-${questCount}`;
        const questName = `ã‚¯ã‚¨ã‚¹ãƒˆ${questCount}`;
        const isDeletable = !isInitial;
        
        questsContainer.insertAdjacentHTML('beforeend', createQuestHtml(questId, questName, isDeletable));
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å†è¨­å®š
        attachEventListeners();
        
        // åˆæœŸã‚¯ã‚¨ã‚¹ãƒˆä»¥å¤–ã¯ã€è¨ˆç®—ã‚’ä¿ƒã™
        if (!isInitial) calculate(); 
    }

    // ç´ æã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addMaterialRow(questElement) {
        const materialContainer = questElement.querySelector('.materials-container');
        if (materialContainer.children.length >= 5) {
            alert('ç´ æã¯æœ€å¤§5ã¤ã¾ã§è¿½åŠ ã§ãã¾ã™ã€‚');
            return;
        }
        
        const newRow = document.createElement('div');
        newRow.classList.add('material-row');
        newRow.innerHTML = `
            <input type="text" placeholder="ç´ æå" class="material-name-input" data-name="name">
            <input type="number" placeholder="ç›®æ¨™å€‹æ•°" class="material-target-input" data-name="target">
            <input type="number" placeholder="ç¾åœ¨ã®å€‹æ•°" class="material-current-input" data-name="current">
            <input type="number" placeholder="ä¸€å‘¨å¹³å‡" class="material-avg-input" data-name="avg">
            <input type="number" placeholder="æ™‚é–“(åˆ†)" class="material-time-input" data-name="time">
            <button class="delete-material-btn">Ã—</button>
        `;
        materialContainer.appendChild(newRow);
        attachEventListeners(); // æ–°ã—ã„å…¥åŠ›æ¬„ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä»˜ä¸
    }
    
    // ã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
    function deleteQuest(questId) {
        const questElement = document.querySelector(`.quest-section[data-quest-id="${questId}"]`);
        if (questElement) {
            questElement.remove();
            reNumberQuests(); // ã‚¯ã‚¨ã‚¹ãƒˆç•ªå·ã‚’æŒ¯ã‚Šç›´ã™
            calculate();
        }
    }
    
    // ã‚¯ã‚¨ã‚¹ãƒˆç•ªå·ã®æŒ¯ã‚Šç›´ã—
    function reNumberQuests() {
        const questElements = questsContainer.querySelectorAll('.quest-section');
        questCount = 0;
        questElements.forEach((el, index) => {
            questCount++;
            const newId = `quest-${questCount}`;
            el.dataset.questId = newId;
            el.querySelector('.quest-header h2').textContent = `ã‚¯ã‚¨ã‚¹ãƒˆ${questCount}`;
            
            // å‰Šé™¤ãƒœã‚¿ãƒ³ã®data-quest-idã‚‚æ›´æ–°
            const deleteBtn = el.querySelector('.delete-quest-btn');
            if(deleteBtn) deleteBtn.dataset.questId = newId;

            // ç´ æè¿½åŠ ãƒœã‚¿ãƒ³ã®data-quest-idã‚‚æ›´æ–°
            el.querySelector('.add-material-btn').dataset.questId = newId;

            // åˆæœŸã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå‰Šé™¤ä¸å¯ï¼‰ã®å ´åˆã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            if (questCount === 1) {
                if (deleteBtn) deleteBtn.remove();
            } else {
                if (!deleteBtn) {
                     el.querySelector('.quest-header').insertAdjacentHTML('beforeend', 
                        `<button class="delete-quest-btn" data-quest-id="${newId}">Ã—</button>`);
                }
            }
        });
    }

    // è¨ˆç®—ã®æ ¸ã¨ãªã‚‹é–¢æ•°
    function calculate() {
        const quests = []; // å…¨ã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
        const materialNeeds = {}; // å…¨ç´ æã®å¿…è¦é‡ã‚’æ ¼ç´ {ç´ æå: å¿…è¦å€‹æ•°}
        
        // STEP 1: å…¨ç´ æã®ç›®æ¨™å¿…è¦æ•°ã‚’é›†è¨ˆ (åå‰ãŒåŒã˜ã‚¢ã‚¤ãƒ†ãƒ ã¯åˆç®—)
        questsContainer.querySelectorAll('.quest-section').forEach(questEl => {
            questEl.querySelectorAll('.material-row').forEach(row => {
                const name = row.querySelector('.material-name-input').value.trim();
                const target = parseFloat(row.querySelector('.material-target-input').value) || 0;
                const current = parseFloat(row.querySelector('.material-current-input').value) || 0;

                
                
                const required = Math.max(0, target - current);

                // ç´ æåãŒç©ºæ¬„ã ã£ãŸå ´åˆã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚­ãƒ¼ã‚’å‰²ã‚Šå½“ã¦ã€‚const key = name === "" ? `(ç„¡åç´ æ ${Math.random()})` : name;
                const key =name !=="" ? name : `_blank_material_%{Math.random()}`;

                if (required > 0) {
                    materialNeeds[key] = (materialNeeds[key] || 0) + required;
                }
            });
        });

        // STEP 2: ã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’æ•´å½¢
        questsContainer.querySelectorAll('.quest-section').forEach(questEl => {
            const questId = questEl.dataset.questId;
            const questData = {
                id: questId,
                name: questEl.querySelector('.quest-header h2').textContent,
                time: 0, // 1å‘¨ã‚ãŸã‚Šã®æ™‚é–“ï¼ˆåˆ†ï¼‰
                materials: {} // {ç´ æå: 1å‘¨ã‚ãŸã‚Šå¹³å‡å…¥æ‰‹é‡}
            };

            let timeInput = 0; // ã‚¯ã‚¨ã‚¹ãƒˆå…¨ä½“ã®æ‰€è¦æ™‚é–“ï¼ˆæœ€å¾Œã«è¦‹ãŸç´ æã®æ™‚é–“ã‚’æ¡ç”¨ã™ã‚‹ï¼‰
            
            questEl.querySelectorAll('.material-row').forEach(row => {
                const name = row.querySelector('.material-name-input').value.trim();
                const avg = parseFloat(row.querySelector('.material-avg-input').value) || 0;
                const time = parseFloat(row.querySelector('.material-time-input').value) || 0;
                
                // ç´ æåãŒç©ºæ¬„ã®å ´åˆã¯ã€é›†è¨ˆæ™‚ã®å‡¦ç†ã«åˆã‚ã›ã¦ã‚­ãƒ¼ã‚’è¨­å®šï¼ˆè¨ˆç®—ã«ã¯ä½¿ã‚ã‚Œãªã„ãŒæ§‹é€ ã‚’åˆã‚ã›ã‚‹ï¼‰
                const key = name === "" ? `(ç„¡åç´ æ ${Math.random()})` : name;
                
                if (avg > 0) {
                    questData.materials[key] = avg;
                }

                if (time > 0) {
                    timeInput = time; // æœ€å¾Œã«æœ‰åŠ¹ãªæ™‚é–“ãŒå…¥ã£ã¦ã„ãŸå€¤ã‚’æ¡ç”¨
                }
            });

            questData.time = timeInput;
            quests.push(questData);
        });

        // STEP 3: æœ€é©ãªå‘¨å›æ•°ã‚’è¨ˆç®—
        const requiredRuns = {}; // {ã‚¯ã‚¨ã‚¹ãƒˆID: å¿…è¦å‘¨å›æ•°}
        let totalRuns = 0;
        let totalTimeMinutes = 0;
        
        // å„ç´ æã®å¿…è¦é‡ãŒãªããªã‚‹ã¾ã§å‘¨å›ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        for (const materialKey in materialNeeds) {
            let required = materialNeeds[materialKey];
            if (required <= 0) continue; // ã™ã§ã«æº€ãŸã•ã‚Œã¦ã„ã‚‹ç´ æã¯ç„¡è¦–

            // ãã®ç´ æã‚’å…¥æ‰‹ã§ãã‚‹ã‚¯ã‚¨ã‚¹ãƒˆã¨ãã®åŠ¹ç‡ï¼ˆ1åˆ†ã‚ãŸã‚Šã®å…¥æ‰‹é‡ï¼‰ã‚’è¨ˆç®—
            const potentialQuests = [];
            quests.forEach(q => {
                const avg = q.materials[materialKey] || 0;
                const time = q.time || Infinity; // æ™‚é–“ãŒãªã„ã‚¯ã‚¨ã‚¹ãƒˆã¯ç„¡é™å¤§ã¨ã—ã¦æ‰±ã†

                if (avg > 0 && time !== Infinity && time > 0) {
                    potentialQuests.push({
                        id: q.id,
                        name: q.name,
                        avg: avg,
                        time: q.time,
                        // åŠ¹ç‡: 1åˆ†ã‚ãŸã‚Šã«å…¥æ‰‹ã§ãã‚‹å€‹æ•°
                        efficiency: avg / q.time 
                    });
                }
            });
            
            // åŠ¹ç‡ãŒæœ€ã‚‚è‰¯ã„ã‚¯ã‚¨ã‚¹ãƒˆã‚’é¸ã¶
            potentialQuests.sort((a, b) => b.efficiency - a.efficiency);
            const bestQuest = potentialQuests[0];

            if (bestQuest) {
                // é¸ã°ã‚ŒãŸã‚¯ã‚¨ã‚¹ãƒˆã§ç´ æã®å¿…è¦æ•°ã‚’æº€ãŸã™ã®ã«å¿…è¦ãªå‘¨å›æ•°ã‚’è¨ˆç®—
                const runsForMaterial = Math.ceil(required / bestQuest.avg);
                
                // ãã®ã‚¯ã‚¨ã‚¹ãƒˆã®å¿…è¦å‘¨å›æ•°ã‚’æ›´æ–°
                const currentRuns = requiredRuns[bestQuest.id] || 0;
                if (runsForMaterial > currentRuns) {
                    // ä»–ã®ç´ æã‚‚ã“ã®ã‚¯ã‚¨ã‚¹ãƒˆã§é›†ã‚ã‚‹å ´åˆã€ã‚ˆã‚Šå¤šã„å‘¨å›æ•°ã‚’æ¡ç”¨
                    requiredRuns[bestQuest.id] = runsForMaterial;
                }
            }
        }
        
        // STEP 4: çµæœã®è¡¨ç¤º
        let resultHtml = '';
        const runDetails = [];

        // å‘¨å›ãŒå¿…è¦ãªã‚¯ã‚¨ã‚¹ãƒˆã®è©³ç´°ã‚’ç”Ÿæˆ
        for (const qId in requiredRuns) {
            const runs = requiredRuns[qId];
            const quest = quests.find(q => q.id === qId);
            const questName = quest ? quest.name : qId;
            const timePerRun = quest ? quest.time : 0;
            
            totalRuns += runs;
            totalTimeMinutes += runs * timePerRun;
            
            resultHtml += `<p>${questName}ã‚’ã€${runs}ã€å‘¨</p>`;
            
            runDetails.push({name: questName, runs: runs, time: runs * timePerRun});
        }

        if (totalRuns === 0) {
             resultHtml = '<p>ã™ã¹ã¦ã®ç´ æã¯ã™ã§ã«æƒã£ã¦ã„ã¾ã™ã€‚å‘¨å›ã¯ä¸è¦ã§ã™ã€‚</p>';
        }

        const finalHours = Math.floor(totalTimeMinutes / 60);
        const finalMinutes = Math.round(totalTimeMinutes % 60);

        questRunsResult.innerHTML = resultHtml;
        totalTimeHoursSpan.textContent = finalHours;
        totalTimeMinutesSpan.textContent = finalMinutes;

        // åŠ¹ç‡çš„ãªå‘¨å›ãƒ—ãƒ©ãƒ³ã®ææ¡ˆ
        displayEfficiencyTip(runDetails, totalTimeMinutes);
    }
    
    // åŠ¹ç‡çš„ãªå‘¨å›ãƒ—ãƒ©ãƒ³ã®ææ¡ˆã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayEfficiencyTip(runDetails, baseTotalTime) {
        efficiencyTipDiv.innerHTML = '';
        if (runDetails.length <= 1) return;

        // å„ã‚¯ã‚¨ã‚¹ãƒˆå˜ç‹¬ã§å¿…è¦ãªæ™‚é–“ã‚’è¨ˆç®—ã—ã€ç¾åœ¨ã®çµ„ã¿åˆã‚ã›æ™‚é–“ã¨æ¯”è¼ƒ
        let bestSingleQuest = {id: null, runs: Infinity, time: Infinity, name: ''};
        let minTimeForSingleQuest = baseTotalTime;

        // å„ã‚¯ã‚¨ã‚¹ãƒˆå˜ç‹¬ã§ã®å‘¨å›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã“ã“ã§ã¯çœç•¥ã—ã¾ã™ãŒã€STEP 3ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨ã—ã¦å®Ÿè£…å¯èƒ½ï¼‰
        // ç¾çŠ¶ã¯è¤‡åˆãƒ«ãƒ¼ãƒˆã®è¨ˆç®—ã®ã¿ã¨ã—ã¦ã€ã“ã“ã§ã¯ç°¡æ½”ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
        
        const tipHtml = `
            <p style="color: blue;">ğŸ’¡ **åŠ¹ç‡åŒ–ã®ãƒ’ãƒ³ãƒˆ:**</p>
            <p>ã“ã®çµ„ã¿åˆã‚ã›ãŒç¾åœ¨ã®ç›®æ¨™é”æˆã«æœ€é©ãªãƒ«ãƒ¼ãƒˆã§ã™ã€‚</p>
            <p>ç‰¹å®šã®ç´ æãŒæƒã£ã¦ã„ã‚‹å ´åˆã€æ®‹ã‚Šã®ç´ æã®ãŸã‚ã«ä»–ã®ã‚¯ã‚¨ã‚¹ãƒˆå˜ç‹¬ãƒ«ãƒ¼ãƒˆã‚’æ¤œè¨ã™ã‚‹ã“ã¨ã§ã€ã•ã‚‰ã«æ™‚é–“ãŒçŸ­ç¸®ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆç¾åœ¨ã¯ã“ã®è¤‡åˆãƒ«ãƒ¼ãƒˆãŒæœ€ã‚‚åŠ¹ç‡çš„ã§ã™ã€‚ï¼‰</p>
        `;

        efficiencyTipDiv.innerHTML = tipHtml;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ä»˜ä¸ã‚’ä¸€æ‹¬ã§è¡Œã†é–¢æ•°
    function attachEventListeners() {
        // ã™ã¹ã¦ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
        document.querySelectorAll('input').forEach(input => {
            input.removeEventListener('input', calculate);
            input.addEventListener('input', calculate);
        });

        // ç´ æè¿½åŠ ãƒœã‚¿ãƒ³
        document.querySelectorAll('.add-material-btn').forEach(btn => {
            btn.removeEventListener('click', handleAddMaterial);
            btn.addEventListener('click', handleAddMaterial);
        });
        
        // ç´ æå‰Šé™¤ãƒœã‚¿ãƒ³
        document.querySelectorAll('.delete-material-btn').forEach(btn => {
            btn.removeEventListener('click', handleDeleteMaterial);
            btn.addEventListener('click', handleDeleteMaterial);
        });

        // ã‚¯ã‚¨ã‚¹ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³
        document.querySelectorAll('.delete-quest-btn').forEach(btn => {
            btn.removeEventListener('click', handleDeleteQuest);
            btn.addEventListener('click', handleDeleteQuest);
        });
    }

    function handleAddMaterial(e) {
        const questId = e.target.dataset.questId;
        const questElement = document.querySelector(`.quest-section[data-quest-id="${questId}"]`);
        addMaterialRow(questElement);
    }

    function handleDeleteMaterial(e) {
        const row = e.target.closest('.material-row');
        row.remove();
        calculate();
    }
    
    function handleDeleteQuest(e) {
        const questId = e.target.dataset.questId;
        deleteQuest(questId);
    }

    // ãƒªã‚»ãƒƒãƒˆé–¢æ•°
    function reset() {
        questsContainer.innerHTML = '';
        questCount = 0;
        addQuest(true); // åˆæœŸã‚¯ã‚¨ã‚¹ãƒˆ1ã‚’å†ç”Ÿæˆ
        calculate();
    }

    // åˆæœŸåŒ–å‡¦ç†
    addQuest(true); // æœ€åˆã®ã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
    addQuestBtn.addEventListener('click', () => addQuest(false)); // ã‚¯ã‚¨ã‚¹ãƒˆè¿½åŠ ãƒœã‚¿ãƒ³
    resetBtn.addEventListener('click', reset);
    
    // åˆå›è¨ˆç®—
    calculate();

</script>

</body>
</html>
